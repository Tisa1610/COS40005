# Ransomware Detector

A hybrid (behavior + static + network) ransomware detection prototype.  
It combines **system behavior telemetry**, **static Portable Executable (PE) features**, and an optional **network-flow model** (UGRansom-style) to score ongoing activity and raise alerts.

---

## Table of Contents
- [Overview](#overview)
- [Project Structure](#project-structure)
- [Data & Models](#data--models)
- [Installation](#installation)
- [Preparing Datasets](#preparing-datasets)
- [Training Models](#training-models)
- [Collecting Behavior Data](#collecting-behavior-data)
- [Real‑Time Monitoring](#real-time-monitoring)
- [Configuration](#configuration)
- [How Detection Works](#how-detection-works)
- [Windows Notes](#windows-notes)
- [Troubleshooting](#troubleshooting)
- [Roadmap / TODOs](#roadmap--todos)
- [License](#license)

---

## Overview

This project aims to demonstrate a multi‑signal ransomware detector:

1. **Behavioral model** — watches CPU usage, file creation/modification rate, network throughput, process churn, average file entropy, extension anomalies, registry modification counts, and thread creation rate.  
2. **Static PE model** — extracts numerical features from Windows executables/DLLs using `pefile` and scores them with a classifier.  
3. **Network model (UGRansom‑style)** — (optional) uses preprocessed network‑flow features to detect ransomware communications.

Models are trained offline and stored in `models/` as `*.pkl` with companion `*_meta.json` describing feature columns. The monitor loads them to compute a **hybrid score** and prints alerts.

---

## Project Structure

```
ransomware_detector/
├─ datasets/                 # raw/reference datasets (input)
│  ├─ pe_dataset.csv
│  └─ ugransom.csv
├─ data/                     # prepared/derived training data (output of prepare_datasets.py)
│  ├─ pe_prepared.csv
│  ├─ system_data.csv        # behavior telemetry collected via data_collector.py
│  └─ ugransom_prepared.csv
├─ models/                   # trained artifacts (created by src/train_model.py)
│  ├─ behavior_model.pkl
│  ├─ behavior_meta.json
│  ├─ pe_model.pkl
│  ├─ pe_meta.json
│  ├─ ugransom_model.pkl
│  └─ ugransom_meta.json
├─ src/
│  ├─ pe_feature_extractor.py   # PE static feature extraction (aligns to meta feature list)
│  ├─ prepare_datasets.py       # cleans/normalizes datasets → data/*.csv
│  └─ train_model.py            # trains RF classifiers and saves models + meta
├─ data_collector.py         # collects behavior telemetry to data/system_data.csv
├─ monitor.py                # real‑time monitor (hybrid scoring and alerts)
└─ RansomwareData.csv        # sample/extra data (optional)
```

---

## Data & Models

- **Behavior telemetry**: Produced by `data_collector.py`; columns include (expected):  
  `cpu, file_rate, net_usage, proc_change, avg_entropy, ext_anomaly, reg_mod, thread_rate, label`  
- **PE dataset**: Numeric PE header/section fields; `label` indicates malicious/benign.  
- **UGRansom dataset**: Numeric network‑flow features; `label` indicates malicious/benign.  

Each trained model has a corresponding `*_meta.json` recording the `feature_names` required at inference. The monitor uses those to align live features.

---

## Installation

**Python**: 3.10–3.12 recommended.

```bash
# Create and activate a virtual environment
python -m venv .venv
# Windows
.\.venv\Scripts\activate
# macOS/Linux
# source .venv/bin/activate

# Install core dependencies
pip install -U pip wheel
pip install psutil watchdog joblib scikit-learn pandas pefile
```

> On Windows, `watchdog` uses efficient file system hooks; on Linux/macOS it falls back to inotify/FSEvents where available. `winreg` is Windows‑only (registry checks).

---

## Preparing Datasets

```bash
# From project root (ransomware_detector/)
python -m src.prepare_datasets
```

This script:
- Cleans `datasets/pe_dataset.csv` → `data/pe_prepared.csv` (drops non‑numerics like file names/hashes, standardizes `label`).  
- Cleans `datasets/ugransom.csv` → `data/ugransom_prepared.csv` (infers/normalizes `label`, keeps only numerics).  
- Leaves `data/system_data.csv` to be generated by the collector (below).

If your CSV schemas differ, adjust `src/prepare_datasets.py` accordingly.

---

## Training Models

```bash
# From project root
python -m src.train_model
```

What it does:
- Trains a **RandomForestClassifier** for behavior, PE, and UGRansom (where data is available).  
- Saves `*_model.pkl` and `*_meta.json` (with `feature_names`) to `models/`.  
- Prints basic classification metrics to stdout.

> Ensure `data/system_data.csv`, `data/pe_prepared.csv`, and `data/ugransom_prepared.csv` exist before training.

---

## Collecting Behavior Data

`data_collector.py` records live telemetry into `data/system_data.csv` at a given interval.

```bash
python data_collector.py --duration 300 --interval 2 --label 0 --folder monitor_folder
```

- `--duration`: total capture time in seconds.  
- `--interval`: sampling interval in seconds.  
- `--label`: `0` = benign capture, `1` = ransomware/suspicious session (for supervised training).  
- `--folder`: directory to watch for file activity (creates it if missing).

It tracks (implementation partially elided in the template):
- CPU utilization
- File system event rate in the watched folder (`watchdog`)
- Network bytes per second
- Process count changes
- Rolling file entropy estimate
- File‑extension anomaly rate
- Registry modifications (Windows)
- Thread creation rate

Rows append to `data/system_data.csv` (created on first run).

---

## Real‑Time Monitoring

Once the three models are trained, run:

```bash
python monitor.py
```

The monitor:
- Observes the target folder for high‑rate changes.
- Optionally scores new/modified executables with the **PE model** (via `src/pe_feature_extractor.py`).
- Computes a **behavior score** from live telemetry.
- Optionally incorporates a **network score** (if you add flows).
- Fuses scores into a **hybrid score** and prints **alerts** like:

```
⚠️ ALERT: Potential ransomware! (hybrid=0.92 | beh=0.87 | pe=0.76) CPU=85.3% | Files/s=120.5 | Net=3.21MB/s
```

> Thresholds and the exact fusion logic are sketched in the code; finalize them in the sections marked with `...` in `monitor.py`.

---

## Configuration

There is no separate config file yet; tweak constants inside scripts:
- **Sampling** intervals and smoothing windows
- **Alert** thresholds (e.g., `THRESHOLD` in `monitor.py`)
- **Watched** folder path
- **Selected** feature lists (via `*_meta.json`)

For PE scoring, `src/pe_feature_extractor.py` ensures the extracted dictionary is **aligned to the model’s `feature_names`**, filling missing values with `0` to avoid crashes.

---

## How Detection Works

1. **Feature Collection**  
   Behavior features are sampled every `interval` seconds. File events come from a `watchdog` observer; CPU and network stats are read via `psutil`; registry checks via `winreg` (Windows).

2. **Model Inference**  
   - Behavior vector → `behavior_model.pkl`  
   - If a PE file appears/changes → extract features with `pefile` → `pe_model.pkl`  
   - (Optional) Network flow vector → `ugransom_model.pkl`

3. **Fusion**  
   The monitor computes a weighted **hybrid score** (e.g., `w1*beh + w2*pe + w3*net`) and compares it to a global threshold. You can escalate actions (e.g., kill process, quarantine file, notify SOAR) in the alert branch.

---

## Windows Notes

- `winreg` imports succeed only on Windows. On Linux/macOS, guard registry code paths or disable them.  
- PE extraction expects Windows PE files; testing on non‑Windows OS may require sample files and paths.  
- For directory monitoring on Windows, `watchdog` is efficient (ReadDirectoryChangesW).

---

## Troubleshooting

- **ImportError: pefile / watchdog not found**  
  Activate your venv and reinstall: `pip install pefile watchdog`.

- **Model feature mismatch**  
  Ensure your input columns match `*_meta.json` → `feature_names`. The extractor pads missing fields with `0` but your training and inference features must correspond semantically.

- **No alerts / false negatives**  
  Lower the `THRESHOLD` or adjust model weights. Verify `data_collector.py` is capturing meaningful variation (try higher activity or different folders).

- **High false positives**  
  Increase `THRESHOLD`, add more benign training data, or tune RandomForest hyperparameters in `src/train_model.py`.

- **Cross‑platform issues**  
  Wrap Windows‑specific code (`winreg`) with `try/except` or `sys.platform` checks.

---

## Roadmap / TODOs

- [ ] Fill in the `...` sections in **`monitor.py`** and **`data_collector.py`** (logic for deriving each behavior feature and model fusion).  
- [ ] Add persistence/hardening (service install, logging to file, rotating logs).  
- [ ] Implement **response actions** (quarantine file, kill suspected process, notify webhook/SOAR).  
- [ ] Provide a sample **config file** for thresholds and paths.  
- [ ] Add unit tests and a minimal CI workflow.  
- [ ] Package as a single CLI (`python -m ransomware_detector ...`) or a Windows service.  

---

## License

No explicit license file was found in the archive. If you plan to publish, choose and add a LICENSE (e.g., MIT/Apache‑2.0).

---

### Appendix: Current Artifacts Detected

This README was generated after inspecting the following files in your upload:

- `datasets/pe_dataset.csv`, `datasets/ugransom.csv`
- `data/pe_prepared.csv`, `data/system_data.csv`, `data/ugransom_prepared.csv`
- `models/*.pkl`, `models/*_meta.json`
- `src/pe_feature_extractor.py`, `src/prepare_datasets.py`, `src/train_model.py`
- `data_collector.py`, `monitor.py`

If any of the above are missing on your machine, follow the steps above to (re)create them.
